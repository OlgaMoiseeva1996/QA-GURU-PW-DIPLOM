name: QA.GURU diploma test
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
permissions:
  contents: write  # ĞÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ğ² gh-pages
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test

      # ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ allure
      - uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: allure-results
          path: allure-results
          retention-days: 20

      # Ğ·Ğ°Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ° allure
      - uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        id: allure-report
        with:
          allure_results: allure-results
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Combine report and history
        if: always()
        run: |
          mkdir -p combined-report
          cp -r allure-report/* combined-report/
          cp -r allure-history combined-report/history/

        # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ· allure-results Ğ¾Ñ‚Ñ‡ĞµÑ‚ allure-report
      - name: Deploy report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: combined-report
          publish_branch: gh-pages

      - name: Install allurectl
        run: |
          curl -o allurectl -L "https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64"
          chmod +x allurectl
          sudo mv allurectl /usr/local/bin/

      - name: Upload results to Allure TestOps
        if: always()
        run: |
          allurectl upload allure-results \
            --endpoint https://allure.autotests.cloud \
            --project-id 4983 \
            --token ${{ secrets.ALLURE_TOKEN }} \
            --launch-name "GitHub Run #${{ github.run_number }}"
      
      - name: Parse Allure summary
        id: parse_summary
        if: always()
        run: |
          SUMMARY_FILE="allure-report/widgets/summary.json"
          if [ -f "$SUMMARY_FILE" ]; then
            PASSED=$(jq '.statistic.passed' $SUMMARY_FILE)
            FAILED=$(jq '.statistic.failed' $SUMMARY_FILE)
            SKIPPED=$(jq '.statistic.skipped' $SUMMARY_FILE)
            TOTAL=$(jq '.statistic.total' $SUMMARY_FILE)
            echo "PASSED=$PASSED" >> $GITHUB_ENV
            echo "FAILED=$FAILED" >> $GITHUB_ENV
            echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          fi
      
      - name: Notify Telegram
        if: always()
        run: |
          STATUS=${{ job.status }}
          # Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
          if [ "$STATUS" = "success" ]; then
            EMOJI="ğŸ‰"
            STATUS_TEXT="Ğ£Ğ¡ĞŸĞ•Ğ¥"
          else
            EMOJI="ğŸš¨" 
            STATUS_TEXT="ĞĞ•Ğ£Ğ”ĞĞ§Ğ"
          fi
    
          MESSAGE="$EMOJI *$STATUS_TEXT* $EMOJI%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ“Š *Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²:*%0A\
          â–«ï¸ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾: *$TOTAL*%0A\
          âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ: *$PASSED*%0A\
          âŒ ĞŸÑ€Ğ¾Ğ²Ğ°Ğ»ĞµĞ½Ğ¾: *$FAILED*%0A\
          â­ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: *$SKIPPED*%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ”— [Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚](https://olgamoiseeva1996.github.io/QA-GURU-PW-DIPLOM/)%0A\
          ğŸ§ª [Allure TestOps](https://allure.autotests.cloud/project/4983)%0A\
          ğŸ“¦ [ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ·ï¸ *Run #${{ github.run_number }}*%0A\
          ğŸ“… $(date '+%d.%m.%Y %H:%M')"

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="$MESSAGE"