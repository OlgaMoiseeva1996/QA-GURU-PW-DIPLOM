name: QA.GURU diploma test
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
permissions:
  contents: write
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npx playwright test

      # ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ allure
      - uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: allure-results
          path: allure-results
          retention-days: 20

      # Ğ·Ğ°Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°
      - name: Get Allure history
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
          submodules: false

      # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹
      - name: Build Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages           # â† Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
          keep_reports: 20

      # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚
      - name: Deploy report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          publish_branch: gh-pages

      - name: Install allurectl
        run: |
          curl -o allurectl -L "https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64"
          chmod +x allurectl
          sudo mv allurectl /usr/local/bin/

      - name: Upload results to Allure TestOps
        if: always()
        run: |
          allurectl upload allure-results \
            --endpoint https://allure.autotests.cloud \
            --project-id 4983 \
            --token ${{ secrets.ALLURE_TOKEN }} \
            --launch-name "GitHub Run #${{ github.run_number }}"
      
      - name: Parse Allure summary
        id: parse_summary
        if: always()
        run: |
          SUMMARY_FILE="allure-report/widgets/summary.json"
          if [ -f "$SUMMARY_FILE" ]; then
            PASSED=$(jq '.statistic.passed' $SUMMARY_FILE)
            FAILED=$(jq '.statistic.failed' $SUMMARY_FILE)
            SKIPPED=$(jq '.statistic.skipped' $SUMMARY_FILE)
            TOTAL=$(jq '.statistic.total' $SUMMARY_FILE)
            echo "PASSED=$PASSED" >> $GITHUB_ENV
            echo "FAILED=$FAILED" >> $GITHUB_ENV
            echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          fi
      
      - name: Notify Telegram
        if: always()
        run: |
          STATUS=${{ job.status }}
          if [ "$STATUS" = "success" ]; then
            EMOJI="ğŸ‰"
            STATUS_TEXT="Ğ£Ğ¡ĞŸĞ•Ğ¥"
          else
            EMOJI="ğŸš¨" 
            STATUS_TEXT="ĞĞ•Ğ£Ğ”ĞĞ§Ğ"
          fi
    
          MESSAGE="$EMOJI *$STATUS_TEXT* $EMOJI%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ“Š *Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²:*%0A\
          â–«ï¸ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾: *$TOTAL*%0A\
          âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ: *$PASSED*%0A\
          âŒ ĞŸÑ€Ğ¾Ğ²Ğ°Ğ»ĞµĞ½Ğ¾: *$FAILED*%0A\
          â­ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: *$SKIPPED*%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ”— [Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚](https://olgamoiseeva1996.github.io/QA-GURU-PW-DIPLOM/)%0A\
          ğŸ§ª [Allure TestOps](https://allure.autotests.cloud/project/4983)%0A\
          ğŸ“¦ [ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ·ï¸ *Run #${{ github.run_number }}*%0A\
          ğŸ“… $(date '+%d.%m.%Y %H:%M')"

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="$MESSAGE"